sm_docker_cache <- new.env(parent = emptyenv())

#' @include utils.R

#' @title Set paws config across smdocker package
#' @param aws_access_key_id (character): AWS access key ID
#' @param aws_secret_access_key (character): AWS secret access key
#' @param aws_session_token (character): AWS temporary session token
#' @param region_name (character): Default region when creating new connections
#' @param profile_name (character): The name of a profile to use. If not given,
#'              then the default profile is used.
#' @param disable_ssl (logical): Whether or not to use SSL. By default, SSL is used.
#' @param anonymous (logical): Set up anonymous credentials when connecting to AWS S3.
#' @param refresh (logical): Refresh cached smdocker config
#' @param ... Other parameters within \code{paws} client.
#' @examples
#' \dontrun{
#' # Require AWS S3 credentials
#'
#' # Set up connection using profile
#' smdocker_config(profile_name = "smdocker_example")
#'
#' # Reset connection to connect to a different region
#' smdocker_config(
#'   profile_name = "smdocker_example",
#'   region_name = "us-east-1",
#'   refresh = TRUE
#' )
#' }
#' @return environment containing smdocker config invisible
#' @export
smdocker_config <- function(aws_access_key_id = NULL,
                            aws_secret_access_key = NULL,
                            aws_session_token = NULL,
                            region_name = NULL,
                            profile_name = NULL,
                            disable_ssl = FALSE,
                            anonymous = FALSE,
                            refresh = FALSE,
                            ...) {
  self <- NULL
  if (!refresh) {
    self <- sm_docker_cache
  }
  if (length(self) == 0) {
    stopifnot(
      "`aws_access_key_id` is required to be a character vector" = (
        is.character(aws_access_key_id) || is.null(aws_access_key_id)
      ),
      "`aws_secret_access_key` is required to be a character vector" = (
        is.character(aws_secret_access_key) || is.null(aws_secret_access_key)
      ),
      "`aws_session_token` is required to be a character vector" = (
        is.character(aws_session_token) || is.null(aws_session_token)
      ),
      "`region_name` is required to be a character vector" = (
        is.character(region_name) || is.null(region_name)
      ),
      "`profile_name` is required to be a character vector" = (
        is.character(profile_name) || is.null(profile_name)
      ),
      "`disable_ssl` is required to be a character vector" = (
        is.logical(disable_ssl)
      ),
      "`anonymous` is required to be a logical vector" = (
        is.logical(anonymous)
      )
    )
    region_name <- region_name %||% get_region(profile_name)
    self[["config"]] <- .cred_set(
      aws_access_key_id,
      aws_secret_access_key,
      aws_session_token,
      profile_name,
      region_name,
      disable_ssl,
      anonymous,
      ...
    )
  }
  return(invisible(self))
}

.cred_set <- function(aws_access_key_id,
                      aws_secret_access_key,
                      aws_session_token,
                      profile_name,
                      region_name,
                      disable_ssl,
                      anonymous,
                      ...) {
  add_list <- function(x) if (length(x) == 0) NULL else x
  config <- list()
  credentials <- list()
  cred <- list()

  cred$access_key_id <- aws_access_key_id
  cred$secret_access_key <- aws_secret_access_key
  cred$session_token <- aws_session_token

  credentials$creds <- add_list(cred)
  credentials$profile <- profile_name
  credentials$anonymous <- anonymous
  config$credentials <- add_list(credentials)
  config$region <- region_name
  config$disable_ssl <- disable_ssl

  return(modifyList(config, list(...)))
}
